<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B1 Homework - Session 8: Transportation Quiz</title>
    <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;background:#5B5091;min-height:100vh;padding:20px}.container{max-width:800px;margin:0 auto}.header{background:#fff;border-radius:20px;padding:30px;margin-bottom:20px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2)}.header img{height:80px;margin-bottom:15px}.header h1{color:#5B5091;font-size:1.4em}.header p{color:#888}.student-info{background:#fff;border-radius:16px;padding:25px;margin-bottom:20px}.student-info label{font-weight:600;color:#333;display:block;margin-bottom:8px}.student-info input,.student-info select{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;margin-bottom:15px;background:#fff}.student-info input:focus,.student-info select:focus{outline:none;border-color:#5B5091}.progress-bar{background:#fff;border-radius:16px;padding:15px 20px;margin-bottom:20px}.progress-track{height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden}.progress-fill{height:100%;background:#F5A623;transition:width .5s}.progress-text{display:flex;justify-content:space-between;margin-top:8px;font-size:14px;color:#666}.section{background:#fff;border-radius:20px;padding:30px;margin-bottom:20px;display:none}.section.active{display:block}.section-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid #eee}.section-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;border:2px solid #5B5091}.section-icon svg{width:24px;height:24px;stroke:#5B5091;stroke-width:2;fill:none}.section-title h2{color:#333;font-size:1.2em}.section-title p{color:#888;font-size:.9em}.btn{background:#5B5091;color:#fff;border:none;padding:14px 32px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s}.btn:hover{background:#4a4080}.btn:disabled{opacity:.5}.btn-secondary{background:#f5f5f5;color:#333}.btn-secondary:hover{background:#eee}.btn-submit{background:#F5A623}.question-card{background:#f8f9fa;border-radius:12px;padding:20px;margin:15px 0;border:1px solid #eee}.question-card h4{margin-bottom:15px;color:#333}.options{display:flex;flex-direction:column;gap:10px}.option{padding:14px 16px;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:12px}.option:hover{border-color:#5B5091;background:#f8f6ff}.option.selected{border-color:#5B5091;background:#f0edff}.option.correct{border-color:#22c55e;background:#f0fdf4}.option.incorrect{border-color:#ef4444;background:#fef2f2}.option span{width:20px;height:20px;border:2px solid #ccc;border-radius:50%}.option.selected span{border-color:#5B5091;background:#5B5091}.writing-area{width:100%;min-height:150px;padding:16px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;resize:vertical;font-family:inherit}.writing-area:focus{outline:none;border-color:#5B5091}.word-count{text-align:right;color:#888;font-size:14px;margin-top:8px}.feedback-box{background:#f8f6ff;border:1px solid #5B5091;border-radius:12px;padding:20px;margin-top:15px;display:none}.feedback-box.visible{display:block}.feedback-box h4{color:#5B5091;margin-bottom:10px}.record-btn{width:80px;height:80px;border-radius:50%;background:#fff;border:3px solid #5B5091;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:20px auto}.record-btn:hover{background:#f8f6ff}.record-btn.recording{border-color:#ef4444;background:#fef2f2;animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 15px rgba(239,68,68,0)}}.record-icon{width:24px;height:24px;background:#5B5091;border-radius:50%}.record-btn.recording .record-icon{border-radius:4px;width:20px;height:20px;background:#ef4444}.recording-status{text-align:center;margin-top:15px;color:#666}.audio-playback{margin-top:20px;display:none}.audio-playback.visible{display:block}.score-card{background:linear-gradient(135deg,#5B5091,#7B6DB5);border-radius:20px;padding:35px;color:#fff;text-align:center}.final-score{font-size:4em;font-weight:700}.score-breakdown{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:25px}.score-item{background:rgba(255,255,255,.15);border-radius:12px;padding:12px 8px}.score-item-label{font-size:.75em;opacity:.9}.score-item-value{font-size:1.4em;font-weight:700}.drag-container{display:flex;flex-wrap:wrap;gap:10px;padding:15px;background:#f5f5f5;border-radius:12px;margin-bottom:15px}.drag-item{background:#fff;padding:12px 18px;border-radius:8px;cursor:grab;border:2px solid #e0e0e0}.drag-item:hover{border-color:#5B5091}.drop-target{min-width:120px;min-height:48px;border:2px dashed #ccc;border-radius:8px;padding:12px;display:flex;align-items:center;justify-content:center;color:#999}.drop-target.filled{border-style:solid;border-color:#5B5091;background:#f8f6ff;color:#333}.match-row{display:grid;grid-template-columns:1fr auto 1fr;gap:15px;align-items:center;margin-bottom:12px}.match-definition{background:#f8f9fa;padding:14px;border-radius:8px;border:1px solid #eee}.loading{display:none;align-items:center;justify-content:center;gap:10px;padding:20px}.loading.visible{display:flex}.spinner{width:24px;height:24px;border:3px solid #e0e0e0;border-top-color:#5B5091;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.nav-buttons{display:flex;justify-content:space-between;margin-top:25px}.prompt-box{background:#f8f6ff;border:1px solid #d4d0e8;border-radius:12px;padding:20px;margin-bottom:20px}.prompt-box h4{color:#5B5091;margin-bottom:10px}.tips-list{margin-top:12px;padding-left:20px}.tips-list li{color:#666;margin-bottom:6px}.submit-section{margin-top:30px;padding-top:25px;border-top:1px solid rgba(255,255,255,.2);text-align:center}

/* NEW STYLES FOR IMPROVED SUBMISSION */
.not-submitted-warning{
  background:#fef2f2;
  border:3px solid #ef4444;
  border-radius:16px;
  padding:20px;
  text-align:center;
  margin-bottom:20px;
  animation:warningPulse 2s infinite;
}
.not-submitted-warning h3{
  color:#ef4444;
  font-size:1.3em;
  margin-bottom:8px;
}
.not-submitted-warning p{
  color:#666;
}
@keyframes warningPulse{
  0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.3)}
  50%{box-shadow:0 0 0 10px rgba(239,68,68,0)}
}
.btn-submit-big{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;
  border:none;
  padding:24px 40px;
  border-radius:16px;
  font-size:22px;
  font-weight:700;
  cursor:pointer;
  width:100%;
  margin-top:15px;
  box-shadow:0 6px 20px rgba(34,197,94,0.4);
  animation:submitPulse 2s infinite;
}
.btn-submit-big:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(34,197,94,0.5);
}
@keyframes submitPulse{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.02)}
}
.submitted-success{
  background:#f0fdf4;
  border:3px solid #22c55e;
  border-radius:16px;
  padding:25px;
  text-align:center;
  margin-bottom:20px;
  display:none;
}
.submitted-success h3{
  color:#22c55e;
  font-size:1.4em;
  margin-bottom:8px;
}
.submitted-success p{
  color:#666;
}
.name-class-input{
  background:rgba(255,255,255,0.1);
  border-radius:12px;
  padding:20px;
  margin:20px 0;
}
.name-class-input label{
  color:#fff;
  font-weight:600;
  display:block;
  margin-bottom:8px;
}
.name-class-input input,.name-class-input select{
  width:100%;
  padding:14px;
  border:2px solid rgba(255,255,255,0.3);
  border-radius:12px;
  font-size:16px;
  margin-bottom:15px;
  background:rgba(255,255,255,0.95);
}
.transcript-box{
  background:#e8f5e9;
  border:1px solid #4caf50;
  border-radius:12px;
  padding:15px;
  margin-top:15px;
}
.transcript-box h4{
  color:#2e7d32;
  margin-bottom:10px;
}
.transcript-box p{
  color:#333;
  font-style:italic;
}

@media(max-width:600px){.match-row{grid-template-columns:1fr}.score-breakdown{grid-template-columns:repeat(3,1fr)}.btn-submit-big{font-size:18px;padding:20px}}</style>
</head>
<body>
<div class="container">
    <div class="header"><h1>üöó Session 8: Transportation Quiz</h1><p>Week 4 ‚Ä¢ Transportation Review Quiz</p></div>
    
    <!-- SECTION 1: Listening -->
    <div class="section active" id="section1">
        <div class="section-header"><div class="section-icon"><svg viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg></div><div class="section-title"><h2>1. Listening</h2><p>Asking for and giving directions</p></div></div>
        <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap"><button class="btn" id="playAudioBtn" onclick="playListening()">‚ñ∂ Play Audio</button><button class="btn btn-secondary" onclick="stopListening()">‚óº Stop</button><button class="btn btn-secondary" onclick="document.getElementById('transcript').style.display='block'">Show Transcript</button></div>
        <div id="transcript" style="background:#f8f9fa;border-radius:12px;padding:20px;display:none;border:1px solid #eee">
            <p style="margin-bottom:10px"><b>Tourist:</b> Excuse me, how do I get to the train station?</p>
            <p style="margin-bottom:10px"><b>Local:</b> Go straight for two blocks, then turn left at the traffic light.</p>
            <p style="margin-bottom:10px"><b>Tourist:</b> Left at the traffic light. Got it.</p>
            <p style="margin-bottom:10px"><b>Local:</b> Then continue past the park. The station is on your right.</p>
            <p><b>Tourist:</b> How long does it take to walk?</p>
            <p><b>Local:</b> About ten minutes. You can't miss it!</p>
        </div>
        <div class="question-card"><h4>1. Where does the tourist want to go?</h4><div class="options" data-q="1" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> Bus stop</div><div class="option" data-v="b" onclick="sel(this)"><span></span> Train station</div><div class="option" data-v="c" onclick="sel(this)"><span></span> Airport</div></div></div>
        <div class="question-card"><h4>2. Where should the tourist turn left?</h4><div class="options" data-q="2" data-c="c"><div class="option" data-v="a" onclick="sel(this)"><span></span> At the park</div><div class="option" data-v="b" onclick="sel(this)"><span></span> At the station</div><div class="option" data-v="c" onclick="sel(this)"><span></span> At the traffic light</div></div></div>
        <div class="question-card"><h4>3. How long is the walk?</h4><div class="options" data-q="3" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> 5 minutes</div><div class="option" data-v="b" onclick="sel(this)"><span></span> 10 minutes</div><div class="option" data-v="c" onclick="sel(this)"><span></span> 20 minutes</div></div></div>
        <div class="nav-buttons"><div></div><button class="btn" onclick="submitS1()">Continue ‚Üí</button></div>
    </div>
    
    <!-- SECTION 2: Vocabulary -->
    <div class="section" id="section2">
        <div class="section-header"><div class="section-icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div><div class="section-title"><h2>2. Vocabulary</h2><p>Match direction phrases</p></div></div>
        <p style="margin-bottom:15px;color:#666">Click a word, then click where it belongs:</p>
        <div class="drag-container" id="wordBank"><div class="drag-item" onclick="pickWord(this)" data-w="turn left">turn left</div><div class="drag-item" onclick="pickWord(this)" data-w="go straight">go straight</div><div class="drag-item" onclick="pickWord(this)" data-w="turn right">turn right</div><div class="drag-item" onclick="pickWord(this)" data-w="intersection">intersection</div><div class="drag-item" onclick="pickWord(this)" data-w="roundabout">roundabout</div><div class="drag-item" onclick="pickWord(this)" data-w="pedestrian crossing">pedestrian crossing</div></div>
        <div><div class="match-row"><div class="match-definition">Go in same direction</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="go straight" onclick="dropWord(this)"></div></div><div class="match-row"><div class="match-definition">Change direction west</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="turn left" onclick="dropWord(this)"></div></div><div class="match-row"><div class="match-definition">Change direction east</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="turn right" onclick="dropWord(this)"></div></div><div class="match-row"><div class="match-definition">Where two roads meet</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="intersection" onclick="dropWord(this)"></div></div><div class="match-row"><div class="match-definition">Circular road junction</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="roundabout" onclick="dropWord(this)"></div></div><div class="match-row"><div class="match-definition">Where people walk across</div><div class="match-arrow">‚Üí</div><div class="drop-target" data-a="pedestrian crossing" onclick="dropWord(this)"></div></div></div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="goTo(1)">‚Üê Back</button><button class="btn" onclick="submitS2()">Continue ‚Üí</button></div>
    </div>
    
    <!-- SECTION 3: Writing -->
    <div class="section" id="section3">
        <div class="section-header"><div class="section-icon"><svg viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></div><div class="section-title"><h2>3. Writing</h2><p>Give directions</p></div></div>
        <div class="prompt-box"><h4>Your Task</h4><p>Write directions from your home to a nearby store or landmark (6-8 sentences).</p><ul class="tips-list"><li>Use: go straight, turn left/right, past, next to</li><li>Include landmarks and distances</li></ul></div>
        <textarea class="writing-area" id="writingResponse" placeholder="From my house, go straight on Main Street...&#10;Turn left at the traffic light...&#10;Continue past the park..." oninput="updateWC()"></textarea>
        <div class="word-count">Words: <span id="wordCount">0</span></div>
        <div class="loading" id="writingLoading"><div class="spinner"></div><span>Reviewing...</span></div>
        <div class="feedback-box" id="writingFeedback"></div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="goTo(2)">‚Üê Back</button><button class="btn" id="writingSubmitBtn" onclick="submitWriting()">Get Feedback ‚Üí</button><button class="btn" id="writingContinueBtn" onclick="goTo(4)" style="display:none">Continue ‚Üí</button></div>
    </div>
    
    <!-- SECTION 4: Speaking -->
    <div class="section" id="section4">
        <div class="section-header"><div class="section-icon"><svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></div><div class="section-title"><h2>4. Speaking</h2><p>Give directions verbally</p></div></div>
        <div class="prompt-box"><h4>Your Task</h4><p>Explain how to get from your home to the nearest supermarket.</p><ul class="tips-list"><li>Speak for 30-60 seconds</li><li>Use direction vocabulary</li></ul></div>
        <button class="record-btn" id="recordBtn" onclick="toggleRec()"><div class="record-icon"></div></button>
        <div class="recording-status" id="recordingStatus">Click to start recording</div>
        <div id="recordingTimer" style="text-align:center;font-size:28px;font-weight:700;color:#5B5091;margin-top:10px">0:00</div>
        <div class="audio-playback" id="audioPlayback"><audio id="recordedAudio" controls style="width:100%"></audio></div>
        <div class="transcript-box" id="transcriptBox" style="display:none"><h4>üìù Your Speech Transcript:</h4><p id="speechTranscript"></p></div>
        <div class="loading" id="speakingLoading"><div class="spinner"></div><span>Analyzing...</span></div>
        <div class="feedback-box" id="speakingFeedback"></div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="goTo(3)">‚Üê Back</button><button class="btn" id="submitSpeakingBtn" onclick="submitSpeaking()" disabled>Continue ‚Üí</button></div>
    </div>
    
    <!-- SECTION 5: Grammar -->
    <div class="section" id="section5">
        <div class="section-header"><div class="section-icon"><svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div><div class="section-title"><h2>5. Grammar Quiz</h2><p>Past Continuous</p></div></div>
        <div class="question-card"><h4>1. I _____ (drive) when the accident happened.</h4><div class="options" data-q="g1" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> drove</div><div class="option" data-v="b" onclick="sel(this)"><span></span> was driving</div><div class="option" data-v="c" onclick="sel(this)"><span></span> am driving</div></div></div>
        <div class="question-card"><h4>2. They _____ (wait) at the bus stop at 8 AM.</h4><div class="options" data-q="g2" data-c="c"><div class="option" data-v="a" onclick="sel(this)"><span></span> waited</div><div class="option" data-v="b" onclick="sel(this)"><span></span> was waiting</div><div class="option" data-v="c" onclick="sel(this)"><span></span> were waiting</div></div></div>
        <div class="question-card"><h4>3. While she _____ (walk), it started to rain.</h4><div class="options" data-q="g3" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> walked</div><div class="option" data-v="b" onclick="sel(this)"><span></span> was walking</div><div class="option" data-v="c" onclick="sel(this)"><span></span> walks</div></div></div>
        <div class="question-card"><h4>4. We _____ (not look) at the map.</h4><div class="options" data-q="g4" data-c="c"><div class="option" data-v="a" onclick="sel(this)"><span></span> didn't looking</div><div class="option" data-v="b" onclick="sel(this)"><span></span> wasn't looking</div><div class="option" data-v="c" onclick="sel(this)"><span></span> weren't looking</div></div></div>
        <div class="question-card"><h4>5. _____ you _____ (follow) the GPS?</h4><div class="options" data-q="g5" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> Did / following</div><div class="option" data-v="b" onclick="sel(this)"><span></span> Were / following</div><div class="option" data-v="c" onclick="sel(this)"><span></span> Was / following</div></div></div>
        <div class="question-card"><h4>6. The children _____ (play) while parents _____ (talk).</h4><div class="options" data-q="g6" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> played / talked</div><div class="option" data-v="b" onclick="sel(this)"><span></span> were playing / were talking</div><div class="option" data-v="c" onclick="sel(this)"><span></span> was playing / was talking</div></div></div>
        <div class="question-card"><h4>7. He _____ (not pay) attention to the road signs.</h4><div class="options" data-q="g7" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> didn't paying</div><div class="option" data-v="b" onclick="sel(this)"><span></span> wasn't paying</div><div class="option" data-v="c" onclick="sel(this)"><span></span> not paying</div></div></div>
        <div class="question-card"><h4>8. At 6 PM yesterday, I _____ (commute) home.</h4><div class="options" data-q="g8" data-c="b"><div class="option" data-v="a" onclick="sel(this)"><span></span> commuted</div><div class="option" data-v="b" onclick="sel(this)"><span></span> was commuting</div><div class="option" data-v="c" onclick="sel(this)"><span></span> commute</div></div></div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="goTo(4)">‚Üê Back</button><button class="btn btn-submit" onclick="submitFinal()">Finish Quiz ‚úì</button></div>
    </div>
    
    <!-- RESULTS SECTION -->
    <div class="section" id="scoreSection">
        <!-- NOT SUBMITTED WARNING -->
        <div class="not-submitted-warning" id="notSubmittedWarning">
            <h3>‚ö†Ô∏è NOT SUBMITTED YET!</h3>
            <p>Your homework is complete but NOT sent to your teacher. Enter your name, select your class, and click the green button below!</p>
        </div>
        
        <!-- SUCCESS MESSAGE -->
        <div class="submitted-success" id="submittedSuccess">
            <h3>‚úÖ SUBMITTED SUCCESSFULLY!</h3>
            <p>Your homework has been sent to your teacher. Great job!</p>
        </div>
        
        <div class="score-card">
            <p style="opacity:.8;margin-bottom:5px">Session 8 Complete!</p>
            <div class="final-score" id="finalScore">0%</div>
            
            <div class="score-breakdown">
                <div class="score-item"><div class="score-item-label">Listening</div><div class="score-item-value" id="listeningScore">0/3</div></div>
                <div class="score-item"><div class="score-item-label">Vocabulary</div><div class="score-item-value" id="vocabScore">0/6</div></div>
                <div class="score-item"><div class="score-item-label">Writing</div><div class="score-item-value" id="writingScore">0/20</div></div>
                <div class="score-item"><div class="score-item-label">Speaking</div><div class="score-item-value" id="speakingScore">0/20</div></div>
                <div class="score-item"><div class="score-item-label">Grammar</div><div class="score-item-value" id="grammarScore">0/8</div></div>
            </div>
            
            <!-- NAME AND CLASS INPUT -->
            <div class="name-class-input" id="nameClassSection">
                <label>üë§ Your Full Name:</label>
                <input type="text" id="studentName" placeholder="Enter your full name...">
                
                <label>üìö Select Your Class:</label>
                <select id="studentClass">
                    <option value="">-- Select your class --</option>
                    <option value="3072-MW-11AM">3072 - Mon/Wed 11:00 AM (Laura Ebel)</option>
                    <option value="3074-MW-8PM">3074 - Mon/Wed 8:00 PM (Laura Ebel)</option>
                    <option value="3080-TTH-11AM">3080 - Tue/Thu 11:00 AM (Laura Ebel)</option>
                    <option value="3082-TTH-8PM">3082 - Tue/Thu 8:00 PM (Laura Ebel)</option>
                    <option value="3085-TTH-945PM">3085 - Tue/Thu 9:45 PM (Eunice Salazar)</option>
                </select>
            </div>
            
            <!-- BIG SUBMIT BUTTON -->
            <button class="btn-submit-big" id="submitBtn" onclick="submitToTeacher()">
                üì§ SUBMIT TO TEACHER
            </button>
        </div>
        
        <div style="text-align:center;margin-top:20px;display:flex;gap:10px;justify-content:center">
            <button class="btn" onclick="window.print()">Print Results</button>
            <button class="btn btn-secondary" onclick="location.reload()">Try Again</button>
        </div>
    </div>
</div>

<script>
const SESSION='8';
let cs=0,sc={l:0,v:0,w:0,s:0,g:0};
let isRec=false,mr=null,ac=[],ri=null,rs=0,isSpeaking=false,voices=[];
let selectedWord=null;
let writingText='',speechTranscriptText='';
let recognition=null;

// Listening script for TTS
const listeningScript=[
    {speaker:'Tourist',text:'Excuse me, ... how do I get to the train station?'},
    {speaker:'Local',text:'Go straight for two blocks, ... then turn left at the traffic light.'},
    {speaker:'Tourist',text:'Left at the traffic light. ... Got it.'},
    {speaker:'Local',text:'Then continue past the park. ... The station is on your right.'},
    {speaker:'Tourist',text:'How long does it take to walk?'},
    {speaker:'Local',text:"About ten minutes. ... You can't miss it!"}
];

// Load voices
function loadVoices(){voices=speechSynthesis.getVoices()}
speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

function getBestVoice(g){
    const d=['Google','Microsoft','Samantha','Daniel'];
    let best=null,bs=0;
    for(const v of voices){
        if(!v.lang.startsWith('en'))continue;
        let s=0;
        for(const x of d){if(v.name.includes(x))s+=10}
        if(v.lang==='en-US')s+=5;
        if(g==='f'&&(v.name.includes('Samantha')||v.name.includes('Karen')))s+=8;
        if(g==='m'&&(v.name.includes('Daniel')||v.name.includes('David')))s+=8;
        if(s>bs){bs=s;best=v}
    }
    return best||voices[0]
}

function playListening(){
    if(isSpeaking)return;
    isSpeaking=true;
    document.getElementById('playAudioBtn').textContent='Playing...';
    document.getElementById('playAudioBtn').disabled=true;
    document.getElementById('transcript').style.display='block';
    let i=0;
    function next(){
        if(i>=listeningScript.length||!isSpeaking){
            isSpeaking=false;
            document.getElementById('playAudioBtn').textContent='‚ñ∂ Play Again';
            document.getElementById('playAudioBtn').disabled=false;
            return
        }
        const l=listeningScript[i];
        const u=new SpeechSynthesisUtterance(l.text);
        u.voice=getBestVoice(l.speaker==='Tourist'?'f':'m');
        u.rate=0.85;
        u.pitch=l.speaker==='Tourist'?1.05:0.95;
        u.onend=()=>{i++;setTimeout(next,800)};
        u.onerror=()=>{i++;setTimeout(next,400)};
        speechSynthesis.speak(u)
    }
    speechSynthesis.cancel();
    setTimeout(next,100)
}

function stopListening(){
    speechSynthesis.cancel();
    isSpeaking=false;
    document.getElementById('playAudioBtn').textContent='‚ñ∂ Play Audio';
    document.getElementById('playAudioBtn').disabled=false
}

function goTo(s){
    cs=s;
    document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
    document.getElementById('section'+s).classList.add('active');
    window.scrollTo(0,0)
}

function sel(e){
    const c=e.closest('.options');
    c.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
    e.classList.add('selected')
}

// Vocabulary - click to select/drop
function pickWord(el){
    document.querySelectorAll('.drag-item').forEach(w=>w.classList.remove('selected'));
    el.classList.add('selected');
    selectedWord=el;
}

function dropWord(target){
    if(!selectedWord||target.classList.contains('filled'))return;
    target.textContent=selectedWord.dataset.w;
    target.classList.add('filled');
    target.dataset.d=selectedWord.dataset.w;
    selectedWord.style.display='none';
    selectedWord.classList.remove('selected');
    selectedWord=null;
}

function updateWC(){
    document.getElementById('wordCount').textContent=document.getElementById('writingResponse').value.trim().split(/\s+/).filter(x=>x).length
}

function submitS1(){
    let c=0;
    document.querySelectorAll('#section1 .options').forEach(o=>{
        const s=o.querySelector('.option.selected');
        if(s&&s.dataset.v===o.dataset.c)c++
    });
    sc.l=c;
    goTo(2)
}

function submitS2(){
    let c=0;
    document.querySelectorAll('.drop-target').forEach(t=>{
        if(t.dataset.d===t.dataset.a)c++
    });
    sc.v=c;
    goTo(3)
}

// IMPROVED WRITING DETECTION
function submitWriting(){
    writingText=document.getElementById('writingResponse').value;
    const text=writingText.toLowerCase();
    document.getElementById('writingLoading').classList.add('visible');
    
    setTimeout(()=>{
        // Count direction phrases (more comprehensive)
        const directionPhrases=[
            'go straight','turn left','turn right','continue','past','next to',
            'opposite','between','at the','on the left','on the right','on your left',
            'on your right','across from','in front of','behind','near','far from',
            'walk','drive','take','first','second','third','block','blocks',
            'corner','intersection','traffic light','stop sign','crosswalk'
        ];
        
        let phraseCount=0;
        directionPhrases.forEach(phrase=>{
            const regex=new RegExp(phrase,'gi');
            const matches=text.match(regex);
            if(matches)phraseCount+=matches.length;
        });
        
        // Count landmarks
        const landmarks=['store','shop','park','bank','school','church','hospital','station',
            'supermarket','restaurant','cafe','hotel','building','house','street','road','avenue'];
        let landmarkCount=0;
        landmarks.forEach(l=>{
            if(text.includes(l))landmarkCount++;
        });
        
        // Word count bonus
        const wordCount=text.trim().split(/\s+/).filter(x=>x).length;
        const wordBonus=wordCount>=40?4:wordCount>=30?3:wordCount>=20?2:0;
        
        // Calculate score
        sc.w=Math.min(20,phraseCount*2+landmarkCount*2+wordBonus);
        
        document.getElementById('writingFeedback').innerHTML=
            '<h4>Feedback</h4>'+
            '<p>‚úÖ Direction phrases found: '+phraseCount+'</p>'+
            '<p>‚úÖ Landmarks mentioned: '+landmarkCount+'</p>'+
            '<p>‚úÖ Word count: '+wordCount+'</p>'+
            '<p><strong>Score: '+sc.w+'/20</strong></p>';
        
        document.getElementById('writingLoading').classList.remove('visible');
        document.getElementById('writingFeedback').classList.add('visible');
        document.getElementById('writingSubmitBtn').style.display='none';
        document.getElementById('writingContinueBtn').style.display='inline-block';
    },1500)
}

// SPEECH RECOGNITION FOR TRANSCRIPTION
function setupSpeechRecognition(){
    if('webkitSpeechRecognition' in window){
        recognition=new webkitSpeechRecognition();
        recognition.continuous=true;
        recognition.interimResults=true;
        recognition.lang='en-US';
        
        recognition.onresult=function(event){
            let transcript='';
            for(let i=0;i<event.results.length;i++){
                transcript+=event.results[i][0].transcript;
            }
            speechTranscriptText=transcript;
            document.getElementById('speechTranscript').textContent=transcript;
            document.getElementById('transcriptBox').style.display='block';
        };
        
        recognition.onerror=function(e){
            console.log('Speech recognition error:',e.error);
        };
    }
}

async function toggleRec(){
    if(!isRec){
        try{
            if(!navigator.mediaDevices)return alert('Browser not supported');
            document.getElementById('recordBtn').style.opacity='0.5';
            document.getElementById('recordingStatus').textContent='Requesting microphone...';
            
            const st=await navigator.mediaDevices.getUserMedia({audio:true});
            document.getElementById('recordBtn').style.opacity='1';
            
            mr=new MediaRecorder(st);
            ac=[];
            mr.ondataavailable=e=>ac.push(e.data);
            mr.onstop=()=>{
                document.getElementById('recordedAudio').src=URL.createObjectURL(new Blob(ac,{type:'audio/webm'}));
                document.getElementById('audioPlayback').classList.add('visible');
                document.getElementById('submitSpeakingBtn').disabled=false
            };
            mr.start();
            
            // Start speech recognition for transcription
            if(recognition){
                try{recognition.start()}catch(e){}
            }
            
            isRec=true;
            rs=0;
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recordingStatus').textContent='Recording... Click again to stop';
            ri=setInterval(()=>{
                rs++;
                document.getElementById('recordingTimer').textContent=Math.floor(rs/60)+':'+(rs%60).toString().padStart(2,'0')
            },1000)
        }catch(e){
            alert('Microphone error: '+e.message)
        }
    }else{
        mr.stop();
        mr.stream.getTracks().forEach(t=>t.stop());
        clearInterval(ri);
        isRec=false;
        
        // Stop speech recognition
        if(recognition){
            try{recognition.stop()}catch(e){}
        }
        
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordingStatus').textContent='Recording saved!'
    }
}

function submitSpeaking(){
    document.getElementById('speakingLoading').classList.add('visible');
    setTimeout(()=>{
        // Score based on duration
        let durationScore=rs>=30?15:rs>=20?12:rs>=10?8:5;
        
        // Bonus for transcript content (if available)
        let contentBonus=0;
        if(speechTranscriptText){
            const text=speechTranscriptText.toLowerCase();
            const dirWords=['left','right','straight','turn','go','walk','continue','past','next'].filter(w=>text.includes(w)).length;
            contentBonus=Math.min(5,dirWords);
        }
        
        sc.s=Math.min(20,durationScore+contentBonus);
        
        let feedbackHTML='<h4>Feedback</h4>'+
            '<p>Duration: '+Math.floor(rs/60)+':'+(rs%60).toString().padStart(2,'0')+'</p>';
        
        if(speechTranscriptText){
            feedbackHTML+='<p>Transcript captured ‚úì</p>';
        }
        
        feedbackHTML+='<p><strong>Score: '+sc.s+'/20</strong></p>';
        
        document.getElementById('speakingFeedback').innerHTML=feedbackHTML;
        document.getElementById('speakingLoading').classList.remove('visible');
        document.getElementById('speakingFeedback').classList.add('visible');
        goTo(5)
    },1500)
}

function submitFinal(){
    let c=0;
    document.querySelectorAll('#section5 .options').forEach(o=>{
        const s=o.querySelector('.option.selected');
        if(s){
            if(s.dataset.v===o.dataset.c){
                c++;
                s.classList.add('correct')
            }else{
                s.classList.add('incorrect');
                o.querySelector('[data-v="'+o.dataset.c+'"]').classList.add('correct')
            }
        }
    });
    sc.g=c;
    
    const tot=sc.l+sc.v+sc.w+sc.s+sc.g;
    const pct=Math.round((tot/57)*100);
    
    document.getElementById('finalScore').textContent=pct+'%';
    document.getElementById('listeningScore').textContent=sc.l+'/3';
    document.getElementById('vocabScore').textContent=sc.v+'/6';
    document.getElementById('writingScore').textContent=sc.w+'/20';
    document.getElementById('speakingScore').textContent=sc.s+'/20';
    document.getElementById('grammarScore').textContent=sc.g+'/8';
    
    document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
    document.getElementById('scoreSection').classList.add('active');
    window.scrollTo(0,0)
}

function submitToTeacher(){
    const name=document.getElementById('studentName').value.trim();
    const studentClass=document.getElementById('studentClass').value;
    
    if(!name){
        alert('‚ö†Ô∏è Please enter your name before submitting!');
        document.getElementById('studentName').focus();
        return;
    }
    if(!studentClass){
        alert('‚ö†Ô∏è Please select your class before submitting!');
        document.getElementById('studentClass').focus();
        return;
    }
    
    const pct=Math.round((sc.l+sc.v+sc.w+sc.s+sc.g)/57*100);
    
    // Build URL with all data including transcript
    let url='https://docs.google.com/forms/d/e/1FAIpQLSf9uEs5MqWLveyoaMBxeWx3pW1b90siwgaom766CpwqnOI7Dg/viewform?usp=pp_url'+
        '&entry.518151516='+encodeURIComponent(name)+
        '&entry.864654596='+encodeURIComponent(SESSION)+
        '&entry.258952242='+encodeURIComponent(sc.l+'/3')+
        '&entry.859150584='+encodeURIComponent(sc.v+'/6')+
        '&entry.1121796741='+encodeURIComponent(sc.w+'/20')+
        '&entry.1435469716='+encodeURIComponent(sc.s+'/20')+
        '&entry.1998281944='+encodeURIComponent(sc.g+'/8')+
        '&entry.1207114914='+encodeURIComponent(pct+'%')+
        '&entry.939912807='+encodeURIComponent(writingText)+
        '&entry.1234567890='+encodeURIComponent(studentClass)+
        '&entry.987654321='+encodeURIComponent(speechTranscriptText);
    
    window.open(url,'_blank');
    
    // Show success message
    document.getElementById('notSubmittedWarning').style.display='none';
    document.getElementById('submittedSuccess').style.display='block';
    document.getElementById('submitBtn').style.display='none';
    document.getElementById('nameClassSection').style.display='none';
}

// Initialize
setupSpeechRecognition();
</script>
</body>
</html>
